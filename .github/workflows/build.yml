name: Build and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Install macOS Dependencies
      if: runner.os == 'macOS'
      run: |
        # JUCE needs these on macOS CI
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

    - name: Configure CMake (macOS)
      if: runner.os == 'macOS'
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0

    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release --parallel 4

    - name: List build artifacts (Debug)
      shell: bash
      run: |
        echo "=== Build output structure ==="
        find build/HowlingWolves_artefacts -type f -name "*.vst3" -o -name "*.component" -o -name "*.app" -o -name "*.exe" -o -name "*.dll" 2>/dev/null || echo "No artefacts directory found"
        echo "=== Full artefacts tree ==="
        ls -R build/HowlingWolves_artefacts/ 2>/dev/null || echo "Directory not found"

    - name: Package (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: |
        mkdir -p artifacts
        # Try both possible paths (with and without Release subfolder)
        if [ -d "build/HowlingWolves_artefacts/Release/VST3" ]; then
          cp -r "build/HowlingWolves_artefacts/Release/VST3/"* artifacts/ 2>/dev/null || true
          cp -r "build/HowlingWolves_artefacts/Release/Standalone/"* artifacts/ 2>/dev/null || true
        elif [ -d "build/HowlingWolves_artefacts/VST3" ]; then
          cp -r "build/HowlingWolves_artefacts/VST3/"* artifacts/ 2>/dev/null || true
          cp -r "build/HowlingWolves_artefacts/Standalone/"* artifacts/ 2>/dev/null || true
        fi
        7z a HowlingWolves_Windows.zip ./artifacts/*

    - name: Package (macOS)
      if: runner.os == 'macOS'
      run: |
        mkdir -p artifacts
        # Try both possible paths (with and without Release subfolder)
        if [ -d "build/HowlingWolves_artefacts/Release/VST3" ]; then
          cp -R "build/HowlingWolves_artefacts/Release/VST3/"* artifacts/ 2>/dev/null || true
          cp -R "build/HowlingWolves_artefacts/Release/Standalone/"* artifacts/ 2>/dev/null || true
          cp -R "build/HowlingWolves_artefacts/Release/AU/"* artifacts/ 2>/dev/null || true
        elif [ -d "build/HowlingWolves_artefacts/VST3" ]; then
          cp -R "build/HowlingWolves_artefacts/VST3/"* artifacts/ 2>/dev/null || true
          cp -R "build/HowlingWolves_artefacts/Standalone/"* artifacts/ 2>/dev/null || true
          cp -R "build/HowlingWolves_artefacts/AU/"* artifacts/ 2>/dev/null || true
        fi
        zip -r HowlingWolves_MacOS.zip artifacts

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: HowlingWolves-${{ matrix.os }}
        path: |
          HowlingWolves_Windows.zip
          HowlingWolves_MacOS.zip

  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts (Windows)
        uses: actions/download-artifact@v4
        with:
          name: HowlingWolves-windows-latest
      
      - name: Download Artifacts (macOS)
        uses: actions/download-artifact@v4
        with:
          name: HowlingWolves-macos-latest

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            HowlingWolves_Windows.zip
            HowlingWolves_MacOS.zip
          fail_on_unmatched_files: false
          generate_release_notes: true
